---
name: design-anchoring
description: 修复问题前的设计锚定，确保理解原设计意图，防止修复偏离设计。
---

# 设计锚定

## 核心理念

> **没有完成设计锚定，不能开始修复。**

修复问题时最大的风险是"越改越乱"，根本原因是没有理解原设计就动手。设计锚定强制在修复前建立"设计基准线"，所有修复都必须符合这条基准线。

---

## 激活方式

### 触发场景

以下场景自动启动本 Skill：

- 修复 Agent 开始处理问题时（自动触发）
- 用户说"修复"、"fix"、"bug"
- 用户说"这里有问题"、"报错了"

### 激活确认

激活时立即响应：

> **设计锚定已启动** 🎯
> 
> 在修复前，我需要先理解原设计。请稍等...

---

## 工作流程

```
定位功能 → 读取设计 → 提取意图 → 对比现状 → 输出锚定报告
```

### 阶段一：定位功能

**目标**：确定问题属于哪个功能模块。

#### 执行步骤

1. 分析问题描述，识别关键词
2. 定位到具体的 SPEC_ID
3. 确认设计文档路径

#### 输出

```markdown
**功能定位**
- 所属规格：{SPEC_ID}
- 设计文档：`docs/features/{SPEC_ID}/design.md`
- 相关代码：`packages/{module}/src/...`
```

---

### 阶段二：读取设计

**目标**：读取并理解原设计文档。

#### 执行步骤

1. 读取 `docs/features/{SPEC_ID}/design.md`
2. 找到与问题相关的章节
3. 提取关键设计决策

#### 文档缺失处理

| 情况 | 处理 |
|------|------|
| 文档存在 | 继续 |
| 文档不存在 | 暂停，提示需要先补文档 |
| 文档过时 | 标记，修复后需同步更新 |

#### 输出

```markdown
**设计文档状态**
- 文档路径：{路径}
- 文档状态：存在 / 不存在 / 疑似过时
- 相关章节：{章节标题}
```

---

### 阶段三：提取意图

**目标**：从设计文档中提取原设计意图。

#### 执行步骤

1. 阅读相关章节
2. 提取核心设计决策
3. 理解"为什么这样设计"

#### 提取维度

| 维度 | 问题 |
|------|------|
| 数据模型 | 用了什么表/字段？为什么？ |
| API 设计 | 接口签名是什么？输入输出？ |
| 业务逻辑 | 核心流程是什么？边界条件？ |
| 约束条件 | 有什么限制？为什么？ |

#### 输出

```markdown
**原设计意图**

> {引用 design.md 原文}

**核心设计决策**
1. {决策1}：{原因}
2. {决策2}：{原因}
```

---

### 阶段四：对比现状

**目标**：对比设计与当前代码，找出偏离点。

#### 执行步骤

1. 读取相关代码文件
2. 对比代码实现与设计描述
3. 识别偏离点

#### 偏离类型

| 类型 | 说明 | 示例 |
|------|------|------|
| 逻辑偏离 | 代码逻辑与设计不符 | 设计说 A→B→C，代码是 A→C |
| 数据偏离 | 数据处理与设计不符 | 设计说必填，代码允许空 |
| 边界偏离 | 边界处理与设计不符 | 设计说报错，代码静默忽略 |
| 契约偏离 | API 与设计不符 | 设计说返回数组，代码返回对象 |

#### 输出

```markdown
**偏离分析**

| 设计要求 | 实际行为 | 偏离类型 |
|----------|----------|----------|
| {设计说} | {代码做} | {类型} |
```

---

### 阶段五：输出锚定报告

**目标**：生成完整的设计锚定报告，作为修复的基准。

#### 锚定报告模板

```markdown
## 设计锚定报告

### 功能定位
- **所属规格**：{SPEC_ID}
- **设计文档**：`docs/features/{SPEC_ID}/design.md`
- **文档状态**：{存在/不存在/疑似过时}

### 原设计意图

> {引用 design.md 相关章节原文}

**核心设计决策**
1. {决策1}
2. {决策2}

### 偏离分析

| 设计要求 | 实际行为 | 偏离类型 |
|----------|----------|----------|
| {设计说} | {代码做} | {类型} |

### 修复基准线

修复必须满足：
- [ ] 符合原设计意图
- [ ] 不改变 API 契约（除非契约本身有误）
- [ ] 不改变数据模型（除非模型本身有误）

### 后续行动

- [ ] 可以开始修复
- [ ] 需要先补充/更新设计文档
- [ ] 需要人工确认设计意图
```

---

## 异常处理

| 情况 | 处理 |
|------|------|
| 设计文档不存在 | 暂停，提示先补文档 |
| 设计文档过时 | 标记，修复后需同步 |
| 无法确定设计意图 | 暂停，询问人类 |
| 发现是设计缺陷 | 提示切换到开发 Agent |

---

## 与其他 Skill 的关系

| Skill | 关系 |
|-------|------|
| problem-fixing | 本 Skill 是 problem-fixing 的前置步骤 |
| doc-sync | 修复后可能需要同步文档 |
| technical-design | 如发现设计缺陷，需切换到此 Skill |

---

## 后续流程

```
design-anchoring → problem-fixing → regression-check → git-operation
```

锚定完成后，进入 `problem-fixing` 执行修复。

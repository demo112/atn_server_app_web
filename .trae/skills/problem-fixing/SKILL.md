---
name: problem-fixing
description: 系统化分析错误并修复，融合四阶段调查法、止损机制与完成验证。
---

## 输入

- 错误信息/验证报告
- 相关代码文件

## 输出

- 修复后的代码
- 验证证据

---

## 核心理念

1. **根因优先** - 先找根因，再修复（来自 systematic-debugging）
2. **止损机制** - 防止越改越乱
3. **增量修复** - 最小改动
4. **记录历史** - 避免重复尝试
5. **证据先于声明** - 修复后必须验证（来自 verification-before-completion）

> **铁律：没有完成根因调查，不能提出修复方案。**
> 
> **铁律：没有运行验证命令，不能声称修复成功。**

---

## 止损机制

### 3次规则

同一问题同一思路最多尝试3次，超过则通知人决定。

### 修复前评估

| 检查项 | 触发条件 | 处理 |
|--------|---------|------|
| 改动范围 | > 3个文件 | 建议回退 |
| 涉及核心逻辑 | 是 | 建议回退 |
| 之前改过同类问题 | 是 | 建议回退 |

任一触发 → 暂停，询问用户

---

## 流程（四阶段调查法 + 止损 + 验证）

```
阶段1: 根因调查（必须完成才能进入阶段2）
   - 仔细阅读错误信息（完整堆栈、错误码）
   - 稳定复现（相同输入、相同环境、记录步骤）
   - 检查最近变更（Git历史、配置、依赖）
   - 多组件系统：逐层添加诊断日志定位失败点
   
阶段2: 模式分析
   - 找到类似的能工作的代码
   - 对比参考文档/规格
   - 识别差异点
   
阶段3: 评估修复方案（止损检查）
   - 改动范围评估
   - 是否涉及核心逻辑
   - 是否尝试过同样方案
   - 任一触发 → 暂停询问用户
   
阶段4: 执行修复
   - 创建失败测试用例（证明Bug存在）
   - 实施单一修复（一次一个变更）
   - 验证修复（原问题解决？新问题？）
   
阶段5: 验证完成（必须有证据）
   - 运行验证命令（测试/构建/lint）
   - 阅读完整输出
   - 确认退出码和结果
   - 只有看到证据才能声称成功
   
后续:
   成功（有证据）→ 回到code-logging重新走完整验证循环
   失败 → 记录方案 → 检查次数 → 继续或通知人
   3+次失败 → 质疑架构，通知人决定
```

---

## 验证要求

### 禁止的声明

❌ "应该修好了"
❌ "我很有信心"
❌ "代码改了，应该可以了"

### 必须的证据

✅ `npm run build` → exit 0
✅ `npm test` → 34/34 pass
✅ 原始错误不再复现

---

## 历史记录

```markdown
## 修复历史: {问题ID}

### 尝试1
- 方案：xxx
- 结果：失败
- 原因：xxx

### 尝试2
- 方案：xxx
- 结果：失败
- 原因：xxx

### 尝试3
- 方案：xxx
- 结果：失败
- 建议：回退到检查点，重新设计
```

---

## 异常处理

| 情况 | 处理 |
|------|------|
| 3次失败 | 通知人决定 |
| 设计问题 | 直接通知人，建议回退 |
| 无法定位问题 | 通知人 |

---

## 与其他 Skill 的关系

| Skill | 关系 |
|-------|------|
| systematic-debugging | 本 Skill 的根因调查方法论来源 |
| verification-before-completion | 本 Skill 的验证要求来源 |
| code-verification | 修复后进入验证流程 |
| code-logging | 修复成功后回到日志流程 |
# 需求锁定规则

## 核心理念

> **需求确认后即锁定，修改需显式解锁** —— 防止需求被随意修改导致代码反复变更。

---

## 锁定机制

### 锁定条件

需求文档在以下情况下自动进入"锁定"状态：

| 触发条件 | 说明 |
|----------|------|
| 用户确认需求 | requirement-analysis 阶段用户说"确认" |
| 进入设计阶段 | 开始 technical-design 后自动锁定 |
| 开始编码 | 进入 code-implementation 后强制锁定 |

### 锁定标记

在 `requirements.md` 文件头部添加 front-matter：

```yaml
---
status: locked
locked_at: 2026-02-05
locked_by: user
change_history:
  - date: 2026-02-05
    action: created
    by: user
---
```

### 锁定状态

| 状态 | 说明 | 允许操作 |
|------|------|----------|
| draft | 草稿 | 自由修改 |
| locked | 已锁定 | 只读，需解锁才能修改 |
| unlocked | 已解锁 | 临时可修改，修改后需重新锁定 |

---

## 解锁流程

### 解锁触发词

用户说以下内容时触发解锁流程：

- "解锁需求"
- "修改需求"
- "需求变更"
- "需求有问题"

### 解锁确认

```markdown
⚠️ **需求解锁确认**

当前需求文档已锁定，解锁后：
1. 需要重新确认需求
2. 可能影响已完成的设计和代码
3. 需要评估变更影响范围

**影响范围**：
- 设计文档：{是否需要更新}
- 已完成代码：{是否需要修改}
- 任务状态：{是否需要重置}

请确认是否解锁？回复"确认解锁"继续。
```

### 解锁后流程

1. 标记需求为 `unlocked`
2. 记录解锁原因
3. 修改完成后重新走确认流程
4. 确认后重新锁定

---

## 变更影响评估

### 评估维度

| 维度 | 检查项 |
|------|--------|
| 设计影响 | design.md 是否需要更新 |
| 代码影响 | 已实现的代码是否需要修改 |
| 测试影响 | 测试用例是否需要更新 |
| 依赖影响 | 是否影响其他模块 |

### 高风险变更

以下变更需要特别谨慎：

| 变更类型 | 风险等级 | 处理方式 |
|----------|----------|----------|
| 删除已实现的功能 | 🔴 高 | 需要人工确认 |
| 修改数据模型 | 🔴 高 | 需要评估迁移方案 |
| 修改 API 契约 | 🟡 中 | 需要通知前端 |
| 修改业务规则 | 🟡 中 | 需要更新测试 |
| 修改 UI 文案 | 🟢 低 | 可直接修改 |

---

## AI 行为规范

### 遇到锁定需求时

```markdown
⚠️ **需求已锁定**

当前需求文档状态为"已锁定"，我无法直接修改。

如果需要修改需求，请说"解锁需求"，我将引导你完成变更流程。
```

### 禁止行为

❌ 不得在用户未明确要求时修改已锁定的需求
❌ 不得绕过解锁流程直接修改需求文档
❌ 不得在编码阶段自行"理解"出新需求

### 允许行为

✅ 可以提示用户需求可能存在的问题
✅ 可以建议用户考虑某些场景
✅ 可以在用户解锁后协助修改需求

---

## 历史案例

### 反面案例：验证码登录反复修改

```
时间线：
15:32 - 移除验证码登录表单
16:33 - 增加验证码登录表单
16:37 - 再次移除验证码登录

根本原因：需求未锁定，AI 根据不同理解反复修改
```

### 正确做法

```
1. 需求分析阶段明确：是否需要验证码登录？
2. 用户确认后锁定需求
3. 后续如需修改，走解锁流程
4. 评估影响后再修改
```

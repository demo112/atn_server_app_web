# 人机协作方法论

## 一、角色定位

### 层级结构

| 层级 | 角色 | 职责 | 类比 |
|------|------|------|------|
| 人 | 决策者 | 提需求、确认设计、验收结果 | 老板 |
| Agent | 流程管理者 | 定义工作流程、调度Skill | 项目经理 |
| Skill | 执行者 | 执行具体步骤 | 操作手册 |
| Rules | 约束 | 全局规范 | 公司制度 |

### 人的角色（极简）

| 角色 | 职责 |
|------|------|
| 需求描述者 | 把想法描述给AI |
| 设计确认者 | 确认设计方案（关键节点） |
| 结果验收者 | 确认功能符合预期 |
| 方向指引者 | AI卡住时提供新思路 |

### AI的角色（全面）

| 角色 | 职责 |
|------|------|
| 需求分析 | 把模糊需求转为结构化文档 |
| 技术设计 | 输出设计方案 |
| 代码实现 | 生成代码 |
| 自测验证 | 运行测试、确认功能 |
| 问题修复 | 分析错误、修复问题 |
| 文档生成 | 生成文档、注释 |

### 核心原则

```
人：说清楚要什么 → 确认设计 → 验收结果
AI：负责中间的一切（分析、设计、编码、测试、修复）
```

---

## 二、协作流程

### 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│  人                                                         │
│  ├── 1. 描述需求                                            │
│  ├── 3. 确认设计（关键节点）                                  │
│  └── 6. 确认结果 → 如果不对，反馈具体问题                     │
└─────────────────────────────────────────────────────────────┘
         ↓1              ↑2            ↓4           ↑5/7
┌─────────────────────────────────────────────────────────────┐
│  Agent                                                      │
│                                                             │
│  阶段一：设计（需人确认）                                     │
│  ├── Skill(需求分析) → 需求文档                              │
│  ├── Skill(技术设计) → 设计文档                              │
│  └── 等待人确认                                              │
│                                                             │
│  阶段二：实现（自主完成）                                     │
│  ├── Skill(任务拆分) → 任务清单                              │
│  ├── 循环：实现 → 自测 → 修复                                │
│  └── Skill(集成测试)                                        │
│                                                             │
│  阶段三：交付与迭代                                          │
│  ├── 交付结果 → 人确认                                       │
│  └── 如果不对 → 增量修改（带止损机制）                        │
└─────────────────────────────────────────────────────────────┘
```

### 关键节点

| 节点 | 人的动作 | 目的 |
|------|---------|------|
| 设计完成后 | 确认设计方案 | 避免方向错误 |
| 交付后 | 确认结果 | 验收功能 |
| 修复失败时 | 决定是否回退 | 防止钻牛角尖 |

---

## 三、止损机制

### 问题：AI容易钻牛角尖

```
问题 → 改A → 引发B → 改B → 引发C → ...（越改越乱）
```

### 解决方案：修复流程带止损

```
收到反馈
    ↓
评估问题类型
    ├── 局部问题 → 增量修改
    │      ↓
    │   修复成功？ → 交付
    │      ↓ 失败
    │   已尝试3次？
    │      ├── 否 → 换思路再试（记录之前方案，避免重复）
    │      └── 是 → 通知人，建议回退
    │                  ↓
    │              人决定：
    │              ├── 同意回退 → 回退到检查点，重新设计
    │              ├── 提供新思路 → 按新思路尝试
    │              └── 再试一次 → 继续
    │
    └── 设计问题 → 直接通知人，建议回退
```

### 关键规则

| 规则 | 说明 |
|------|------|
| 3次上限 | 同一问题同一思路最多尝试3次 |
| 记录历史 | 记录之前尝试过的方案，避免重复 |
| 检查点 | 每个稳定功能完成时创建（Git commit） |
| 人介入 | 3次失败后通知人决定，而非自动回退 |

### 判断"设计问题"的标准

- 改动范围 > 3个文件
- 改动涉及核心逻辑
- 之前改过同类问题

---

## 四、质量保障

### 核心理念

**单一验证不可信，多重独立验证提升可信度。**

在人类无法判断代码正确性的场景下，采用四维验证框架：

| 维度 | 目的 | 方法 |
|------|------|------|
| 契约验证 | 形式化需求 | 属性测试、前后置条件 |
| 自洽性验证 | 内部逻辑一致 | 类型系统、运行时断言 |
| 对抗性验证 | 抵抗攻击 | 模糊测试、变异测试 |
| 交叉验证 | 多视角一致 | 独立审查、需求重述 |

详见：[AI代码验证系统](./skills/ai-code-verification.md)

### 人的验收角色

人类不需要判断代码对不对，只需要：
1. **确认需求理解** - 契约是否正确表达了需求
2. **在分歧点决策** - 当多视角理解不一致时做选择
3. **接受风险** - 了解风险点后决定是否继续

### 可信度评分

| 等级 | 分数 | 含义 |
|------|------|------|
| A | 90-100 | 高可信度，可放心使用 |
| B | 80-89 | 良好，存在小风险 |
| C | 70-79 | 一般，需关注风险点 |
| D | 60-69 | 较低，建议补充验证 |
| F | <60 | 不可信，需重新验证 |

### 常见问题与应对

| 问题 | 应对 |
|------|------|
| AI说完成但实际没完成 | 四维验证，不信AI的话 |
| 修复越改越乱 | 触发止损机制，回退重来 |
| 设计方向错误 | 在设计确认节点拦截 |
| AI对需求理解有偏差 | 交叉验证发现分歧，人类决策 |
| 测试本身有Bug | 变异测试验证测试质量 |
| 边界情况遗漏 | 模糊测试 + 属性测试自动探索 |

---

## 五、2人团队分工

详见 `03-项目组织方案.md` 第六节。

核心要点：
- 功能垂直切分（各自负责不同功能模块）
- 命名空间隔离（防止AI生成的代码冲突）
- 各自指挥AI完成负责的模块

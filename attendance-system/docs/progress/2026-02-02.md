# 进度日志：2026-02-02

## 概要
- **SW66 补签处理**: 已完成 (负责人: naruto)
- **UA1 用户管理与认证**: 已完成 (负责人: sasuke)

## SW66 补签处理 (Naruto)

### 完成任务
1. **Task 1: 定义补签相关类型 (Shared)** - 完成
   - 文件: `packages/shared/src/types/attendance/correction.ts`
   - 内容: 定义了 `CorrectionType`, `QueryDailyRecordsDto`, `DailyRecordVo` 等类型。
2. **Task 2: 实现核心考勤计算引擎 (Domain)** - 完成
   - 文件: `packages/server/src/modules/attendance/domain/attendance-calculator.ts`
   - 内容: 实现了迟到、早退、缺勤的计算逻辑。
3. **Task 3: 实现补签服务 (Server)** - 完成
   - 文件: `packages/server/src/modules/attendance/correction/attendance-correction.service.ts`
   - 内容: 实现了 `checkIn` 和 `checkOut` 补签逻辑，使用事务保证数据一致性。
4. **Task 4: 实现补签控制器与路由 (Server)** - 完成
   - 文件: `packages/server/src/modules/attendance/correction/attendance-correction.controller.ts`
   - 内容: 实现了 REST API 接口。
5. **Task 5: 封装补签 API (Web)** - 完成
   - 文件: `packages/web/src/services/attendance-correction.ts`
   - 内容: 封装了 Axios 请求。
6. **Task 6: 实现异常考勤列表页 (Web)** - 完成
   - 文件: `packages/web/src/pages/attendance/correction/CorrectionPage.tsx`
   - 内容: 实现了异常考勤查询列表。
7. **Task 7: 实现补签弹窗组件 (Web)** - 完成
   - 文件: `packages/web/src/pages/attendance/correction/components/*.tsx`
   - 内容: 实现了补签到和补签退弹窗。
8. **Task 8: 集成测试 (E2E)** - 完成
   - 文件: `packages/server/src/modules/attendance/__tests__/attendance-correction.integration.test.ts`
   - 内容: 验证了后端 API 流程。

### 补充更新 (17:00)
- **文档维护**:
  - 清理了 `docs/features/SW62` 和 `docs/features/SW66` 的冗余文件。
  - 生成了 SW66 的验收报告 (`acceptance.md`) 和总结报告 (`summary.md`)。
  - 确认了 UA1 需求文档缺失，需后续补齐。
- **SW66 验收**: 集成测试通过，API 功能符合预期，已生成验收报告。

## UA1 用户管理与认证 (Sasuke)

### 任务完成情况
- [x] **Server 端 Auth/User 模块实现**: 完成 API 开发
- [x] **Web 端 Login/User 页面实现**: 完成页面开发
- [x] **App 端 Login 功能实现**: 完成 App 登录
- [x] **构建修复**: 修复构建错误和类型问题
- [x] **集成测试**: 验证通过 (11 ACs)

### 验证记录
- **集成测试**: UA1 功能集成测试通过 (11 ACs, 100% Pass)
  - 验证了用户管理 (增删改查)
  - 验证了认证流程 (登录/JWT)
  - 验证了接口权限 (Token校验)
  - 报告位置: `docs/features/UA1/acceptance.md`

## 遇到的问题与解决

### SW66
- **Web 端类型错误**: `departmentId` vs `deptId` 不一致。
  - **解决**: 统一使用 `deptId` 和 `deptName`，与 Shared 类型保持一致。
- **PSReadLine 错误**: 终端输出被截断导致的显示问题。
  - **解决**: 忽略非阻塞错误，确认命令执行成功。

### UA1
- **Server 测试 enum 导入问题**: `UserRole` enum 在测试中导入失败，改为字面量字符串解决。
- **Web 构建类型错误**: `UserList.tsx` 和 `ScheduleDialog.tsx` 存在类型定义缺失，已修复。
- **Git 分支分叉**: 本地提交领先远程，需要 rebase。
  - **解决**: 已完成同步与合并。

## UA3 部门管理 (Sasuke)

### 任务完成情况
- [x] **需求分析与设计**: 完成文档编写，确认移除拖拽功能
- [x] **Task 1: 公共类型定义**: 实现 DepartmentVO/DTOs
- [x] **Task 2: Service 逻辑**: 实现树形构建与循环引用检查
- [x] **Task 3: Controller 实现**: 完成 REST API
- [x] **Task 4: Web 页面框架**: 集成 AntD Tree 与 Layout
- [x] **Task 5: 交互功能**: 完成增删改 Modal
- [x] **Task 6: 公共组件**: 实现 DepartmentSelect 供其他模块调用

### 验证
- **Web Build**: 通过
- **API**: 与契约一致 (GET/POST/PUT/DELETE)


## 补充更新 (SW63 时间段设置)

### 完成任务 (SW63)
1. **Task 1-6: Server 端实现 (之前已完成)**
   - 实现了 AttTimePeriod 模型、Service、Controller 及集成测试。

2. **Task 7: 实现时间段 Service (Web)** - 完成
   - 文件: `packages/web/src/services/time-period.ts`
   - 内容: 封装了时间段管理的 CRUD API。

3. **Task 8: 实现时间段列表页 (Web)** - 完成
   - 文件: `packages/web/src/pages/attendance/time-period/TimePeriodPage.tsx`
   - 内容: 实现了时间段列表展示和删除功能。

4. **Task 9: 实现时间段表单组件 (Web)** - 完成
   - 文件: `packages/web/src/pages/attendance/time-period/components/TimePeriodDialog.tsx`
   - 内容: 实现了时间段的新增与编辑弹窗，支持固定/弹性班制规则配置。

5. **Task 10: Web 路由集成与联调** - 完成
   - 文件: `packages/web/src/App.tsx`
   - 内容: 配置了 `/attendance/time-periods` 路由。

### 完成任务 (SW62 考勤制度)
1. **Task 5: 实现考勤设置 Service (Web)** - 完成
   - 文件: `packages/web/src/services/attendance-settings.ts`
   - 内容: 封装了考勤制度设置的 API。

2. **Task 6: 实现考勤设置页面 (Web)** - 完成
   - 文件: `packages/web/src/pages/attendance/settings/AttendanceSettingsPage.tsx`
   - 内容: 实现了考勤日切换时间的配置页面。

3. **Task 7: Web 路由集成 (Web)** - 完成
   - 文件: `packages/web/src/App.tsx`
   - 内容: 配置了 `/attendance/settings` 路由，修复了异常考勤路由缺失问题。

### 遇到的问题与解决
- **Web 端构建错误**: `packages/web` 目录下运行 `tsc` 通过，但在根目录运行 `tsc` 报其他模块错误。

## 补充更新 (SW68 补签记录)

### 完成任务 (SW68)
1. **Task 1: 更新数据模型 (Server)** - 完成
   - 文件: `packages/server/prisma/schema.prisma`
   - 内容: `AttCorrection` 表增加 `updatedAt` 字段。

2. **Task 2: 定义共享类型 (Shared)** - 完成
   - 文件: `packages/shared/src/types/attendance/correction.ts`
   - 内容: 增加 `QueryCorrectionsDto`, `UpdateCorrectionDto` 等类型。

3. **Task 3: 实现考勤重算核心逻辑 (Server)** - 完成
   - 文件: `packages/server/src/modules/attendance/attendance-correction.service.ts`
   - 内容: 实现了优先使用补签记录的考勤状态重算逻辑，并支持实时更新。

4. **Task 4: 实现补签管理服务 (Server)** - 完成
   - 文件: `packages/server/src/modules/attendance/attendance-correction.service.ts`
   - 内容: 实现了补签记录的查询、更新、删除方法。

5. **Task 5: 实现补签管理接口 (Server)** - 完成
   - 文件: `packages/server/src/modules/attendance/attendance-correction.controller.ts`
   - 内容: 实现了 REST API 接口，包括 GET/PUT/DELETE。

6. **Task 6: 验证补签管理功能 (集成测试)** - 完成
   - 文件: `packages/server/src/modules/attendance/__tests__/attendance-correction.integration.test.ts`
   - 内容: 验证了 CRUD 操作及状态重算逻辑。

### 关键决策
- **实时重算**: 补签记录增删改时立即触发状态重算，无需单独的重算任务。
- **物理删除**: 补签记录采用物理删除，简化逻辑，符合用户要求。
- **数据加载**: 默认加载最近一个月的补签记录，优化性能。

### 下一步计划
- 等待 SW68 验收。
- 部署测试环境验证。

## UA2 人员管理 (Sasuke)

### 完成任务
1. **Task 1: 数据库模型与共享类型** - 完成
   - 修改 EmployeeStatus 枚举 (active/deleted)，定义共享类型。
2. **Task 2: Employee DTO 与 Service 实现** - 完成
   - 实现 CRUD 逻辑，支持伪物理删除 (Soft Delete with Rename)。
3. **Task 3: Employee Controller 与路由注册** - 完成
   - 实现 API 接口，集成错误处理与标准响应格式。
4. **Task 4: 前端 Service 封装** - 完成
   - 封装 Employee API 调用。
5. **Task 5: 员工列表与删除功能** - 完成
   - 实现列表展示、搜索、删除功能。
6. **Task 6: 员工编辑/新增弹窗** - 完成
   - 实现新增/编辑表单，支持账号绑定/解绑。
7. **Task 7: 集成测试与文档同步** - 完成
   - 编写集成测试，验证完整业务流程。

### 遇到的问题与解决
- **测试报错**: 缺少 createdAt/updatedAt 字段，通过 Mock 解决。
- **依赖问题**: pino 依赖缺失，通过 Mock logger 解决。
- **集成测试 500 错误**: Zod 验证错误未被全局处理，导致 500。
  - **解决**: 在 error-handler.ts 中添加 ZodError 处理逻辑。
- **响应格式不统一**: 测试期望 success: true 但 Controller 直接返回对象。
  - **解决**: 统一 Controller 响应格式为 { success: true, data: T }。

### 状态
- 代码已提交 (feat/UA2)
- 文档已同步
- 测试已通过

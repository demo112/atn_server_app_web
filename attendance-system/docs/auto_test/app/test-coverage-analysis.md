# Appç«¯æµ‹è¯•è¦†ç›–ç›²åŒºåˆ†ææŠ¥å‘Š

## ä¸€ã€åˆ†ææ¦‚è¦
- **åˆ†æèŒƒå›´**ï¼š`packages/app` (é‡ç‚¹å…³æ³¨ Auth å’Œ Attendance æ¨¡å—)
- **ç°æœ‰æµ‹è¯•**ï¼š
  - `LoginScreen.test.tsx`: è¦†ç›–äº†åŸºç¡€ç™»å½•æµç¨‹
  - `CheckInButton.test.tsx`: ç®€å•ç»„ä»¶æµ‹è¯•
  - `schemas/__tests__/*.test.ts`: æ•°æ®æ¨¡å‹æ ¡éªŒæµ‹è¯•
- **å‘ç°ç›²åŒº**ï¼šæ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ `ClockInScreen` (æ‰“å¡) å®Œå…¨æ— æµ‹è¯•è¦†ç›–ï¼›`LoginScreen` ç¼ºä¹å¼‚å¸¸åœºæ™¯è¦†ç›–ã€‚

## äºŒã€æ–¹æ³•è®ºè¦†ç›–å®¡æŸ¥

### 2.1 ç­‰ä»·ç±»åˆ’åˆ†

| æ¨¡å— | è¾“å…¥é¡¹ | å·²è¦†ç›–ç­‰ä»·ç±» | é—æ¼ç­‰ä»·ç±» | é£é™©ç­‰çº§ |
|------|--------|-------------|-----------|----------|
| **Login** | ç”¨æˆ·å/å¯†ç  | æœ‰æ•ˆå€¼ã€ç©ºå€¼ | ç‰¹æ®Šå­—ç¬¦ã€è¶…é•¿å­—ç¬¦ã€é¦–å°¾ç©ºæ ¼ | ğŸŸ¢ ä½ |
| **ClockIn** | æ‰“å¡ç±»å‹ | - | ä¸Šç­ã€ä¸‹ç­ | ğŸ”´ é«˜ |
| **ClockIn** | å®šä½ä¿¡æ¯ | - | æœ‰æ•ˆå®šä½ã€å®šä½å¤±è´¥ã€æ¨¡æ‹Ÿå®šä½(é˜²ä½œå¼Š) | ğŸ”´ é«˜ |
| **ClockIn** | è®¾å¤‡ä¿¡æ¯ | - | æœ‰æ•ˆè®¾å¤‡IDã€è·å–å¤±è´¥ | ğŸŸ¡ ä¸­ |

### 2.2 è¾¹ç•Œå€¼åˆ†æ

| æ¨¡å— | è¾¹ç•Œç±»å‹ | è¾¹ç•Œå€¼ | æ˜¯å¦è¦†ç›– | é£é™©ç­‰çº§ |
|------|----------|--------|----------|----------|
| **ClockIn** | æ—¶é—´è¾¹ç•Œ | è·¨å¤©æ‰“å¡ (23:59:59 -> 00:00:01) | âœ— | ğŸŸ¡ ä¸­ |
| **ClockIn** | è·ç¦»è¾¹ç•Œ | å…è®¸èŒƒå›´è¾¹ç¼˜ (å¦‚500m) | âœ— | ğŸ”´ é«˜ |
| **Login** | è¾“å…¥é•¿åº¦ | æœ€å¤§é•¿åº¦é™åˆ¶ | âœ— | ğŸŸ¢ ä½ |

### 2.3 çŠ¶æ€è½¬æ¢æµ‹è¯•

**LoginScreen çŠ¶æ€çŸ©é˜µ**ï¼š
- Idle -> Loading -> Success (å·²è¦†ç›–)
- Idle -> Loading -> Error (å·²è¦†ç›–)
- **é—æ¼**ï¼šLoading çŠ¶æ€ä¸‹å†æ¬¡ç‚¹å‡»ç™»å½• (é˜²é‡å¤æäº¤)

**ClockInScreen çŠ¶æ€çŸ©é˜µ**ï¼š
- æœªæ‰“å¡ -> æ‰“å¡ä¸­ -> å·²æ‰“å¡
- **é—æ¼**ï¼š
  - å¹¶å‘ç‚¹å‡»æ‰“å¡æŒ‰é’® (é˜²é‡å¤)
  - æ‰“å¡å¤±è´¥åçš„é‡è¯•çŠ¶æ€æ¢å¤

### 2.4 åœºæ™¯æ³•

| åœºæ™¯ç±»å‹ | åœºæ™¯æè¿° | æ˜¯å¦è¦†ç›– |
|----------|----------|----------|
| **ä¸»æµç¨‹** | ç™»å½• -> è¿›å…¥é¦–é¡µ -> ç‚¹å‡»æ‰“å¡ -> æˆåŠŸ | âœ— (ç¼ºä¹é›†æˆæµ‹è¯•) |
| **å¼‚å¸¸æµç¨‹** | æ‰“å¡æ—¶å®šä½æƒé™è¢«æ‹’ç» | âœ— |
| **å¼‚å¸¸æµç¨‹** | æ‰“å¡æ—¶ç½‘ç»œæ–­å¼€/è¶…æ—¶ | âœ— |
| **å¼‚å¸¸æµç¨‹** | Token è¿‡æœŸå¯¼è‡´æ‰“å¡å¤±è´¥ | âœ— |

### 2.5 é”™è¯¯æ¨æµ‹ (Error Guessing)

| é”™è¯¯æ¨¡å¼ | å…·ä½“åœºæ™¯ | é£é™©ç­‰çº§ |
|----------|----------|----------|
| **å¹¶å‘ä¸ç«æ€** | å¿«é€Ÿè¿ç»­ç‚¹å‡»ç™»å½•/æ‰“å¡æŒ‰é’® | ğŸ”´ é«˜ |
| **æƒé™è¾¹ç•Œ** | ç™»å½•å Session å¤±æ•ˆ/è¢«è¸¢ä¸‹çº¿ | ğŸŸ¡ ä¸­ |
| **ç¯å¢ƒå¼‚å¸¸** | GPS ä¿¡å·å¼±/å®šä½æ¼‚ç§» | ğŸ”´ é«˜ |
| **æ•°æ®ä¸€è‡´æ€§** | æ‰“å¡æˆåŠŸä½†æœ¬åœ°åˆ—è¡¨æœªåˆ·æ–° | ğŸŸ¡ ä¸­ |

## ä¸‰ã€è¡¥å……ç”¨ä¾‹å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»è¡¥å……ï¼‰

**ç”¨ä¾‹1ï¼šClockInScreen åŸºç¡€åŠŸèƒ½è¦†ç›–**
- **ç›®çš„**ï¼šç¡®ä¿æ ¸å¿ƒæ‰“å¡åŠŸèƒ½å¯ç”¨
- **æ­¥éª¤**ï¼š
  1. æ¸²æŸ“ `ClockInScreen`
  2. Mock `clockIn` API è¿”å›æˆåŠŸ
  3. ç‚¹å‡» "ä¸Šç­æ‰“å¡"
- **é¢„æœŸ**ï¼šè°ƒç”¨ APIï¼Œæ˜¾ç¤ºæˆåŠŸæç¤ºï¼Œåˆ·æ–°è®°å½•åˆ—è¡¨

**ç”¨ä¾‹2ï¼šClockInScreen é˜²é‡å¤æäº¤**
- **ç›®çš„**ï¼šé˜²æ­¢ç”¨æˆ·å¿«é€Ÿç‚¹å‡»å¯¼è‡´äº§ç”Ÿå¤šæ¡æ‰“å¡è®°å½•
- **æ­¥éª¤**ï¼š
  1. ç‚¹å‡»æ‰“å¡æŒ‰é’®
  2. åœ¨ Loading ç»“æŸå‰å†æ¬¡ç‚¹å‡»
- **é¢„æœŸ**ï¼šAPI ä»…è¢«è°ƒç”¨ä¸€æ¬¡

**ç”¨ä¾‹3ï¼šClockInScreen å®šä½ä¸è®¾å¤‡ä¿¡æ¯é€ä¼ **
- **ç›®çš„**ï¼šç¡®ä¿æ‰“å¡è¯·æ±‚æºå¸¦äº†å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- **æ­¥éª¤**ï¼š
  1. Mock `location` å’Œ `deviceInfo`
  2. è§¦å‘æ‰“å¡
- **é¢„æœŸ**ï¼šAPI è°ƒç”¨å‚æ•°åŒ…å«æ­£ç¡®çš„ location å’Œ deviceInfo

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®è¡¥å……ï¼‰

**ç”¨ä¾‹4ï¼šLoginScreen ç½‘ç»œè¶…æ—¶å¤„ç†**
- **ç›®çš„**ï¼šéªŒè¯ç½‘ç»œå¼‚å¸¸æ—¶çš„ç”¨æˆ·ä½“éªŒ
- **æ­¥éª¤**ï¼š
  1. Mock `login` API æŠ›å‡ºè¶…æ—¶é”™è¯¯
  2. ç‚¹å‡»ç™»å½•
- **é¢„æœŸ**ï¼šLoading æ¶ˆå¤±ï¼Œæ˜¾ç¤º"ç½‘ç»œè¯·æ±‚è¶…æ—¶"æç¤º (è€Œéé€šç”¨é”™è¯¯)

**ç”¨ä¾‹5ï¼šClockInScreen è®°å½•åˆ—è¡¨æ¸²æŸ“**
- **ç›®çš„**ï¼šéªŒè¯æ‰“å¡è®°å½•æ­£ç¡®æ˜¾ç¤º
- **æ­¥éª¤**ï¼š
  1. Mock `getClockRecords` è¿”å›ä¸€ç»„æ•°æ®
  2. æ¸²æŸ“å±å¹•
- **é¢„æœŸ**ï¼šæ­£ç¡®æ˜¾ç¤ºä¸Šç­/ä¸‹ç­çŠ¶æ€ã€æ—¶é—´å’Œåœ°å€

## å››ã€å®æ–½è®¡åˆ’

1. **Phase 1**: ä¸º `ClockInScreen` åˆ›å»ºåŸºç¡€å•å…ƒæµ‹è¯• (`packages/app/src/screens/attendance/ClockInScreen.test.tsx`)ã€‚
2. **Phase 2**: å¢å¼º `LoginScreen` æµ‹è¯•ï¼Œè¦†ç›–é˜²é‡å¤æäº¤ã€‚
3. **Phase 3**: å»ºç«‹ App ç«¯çš„é›†æˆæµ‹è¯•ç¯å¢ƒ (Integration Test Setup)ã€‚

## äº”ã€ä»£ç ç¤ºä¾‹ (ClockInScreen æµ‹è¯•éª¨æ¶)

```typescript
import React from 'react';
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import ClockInScreen from './ClockInScreen';
import { clockIn } from '../../services/attendance';

// Mock services
jest.mock('../../services/attendance', () => ({
  clockIn: jest.fn(),
  getClockRecords: jest.fn().mockResolvedValue([]),
}));

// Mock utils
jest.mock('../../utils/auth', () => ({
  getUser: jest.fn().mockResolvedValue({ employeeId: 1 }),
}));

describe('ClockInScreen', () => {
  it('prevents duplicate submission', async () => {
    (clockIn as jest.Mock).mockImplementation(() => new Promise(r => setTimeout(r, 100)));
    
    const { getByText } = render(<ClockInScreen />);
    const button = getByText('ä¸Šç­æ‰“å¡'); // å‡è®¾æŒ‰é’®æ–‡æœ¬
    
    fireEvent.press(button);
    fireEvent.press(button);
    
    expect(clockIn).toHaveBeenCalledTimes(1);
  });
});
```

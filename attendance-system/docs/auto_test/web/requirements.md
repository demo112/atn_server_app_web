# [Web] 测试盲区分析报告

## 一、分析概要
- **分析范围**：`packages/web/src` (全模块覆盖：Auth, Attendance, Department, Employee, Statistics)
- **现有测试**：
  - 集成测试：
    - `__tests__/integration/auth/login.test.tsx` (✅ Auth/Login)
    - `__tests__/integration/attendance/correction.test.tsx` (✅ Attendance/Correction)
    - `__tests__/integration/department/department.test.tsx` (✅ Organization/Department)
    - `__tests__/integration/employee/employee.test.tsx` (✅ Organization/Employee)
    - `__tests__/integration/leave/leave.test.tsx` (✅ Attendance/Leave)
    - `__tests__/integration/shift/shift.test.tsx` (✅ Attendance/Shift)
    - `__tests__/integration/schedule/schedule.test.tsx` (✅ Attendance/Schedule)
    - `__tests__/integration/statistics/statistics.test.tsx` (✅ Statistics/Report)
  - 单元测试：`utils/*.test.ts`, `schemas/__tests__/*.test.ts`
  - 组件测试：`components/DepartmentSelect/*.test.tsx`
- **覆盖状态更新 (2026-02-04)**：
  - **Leave**: ✅ 已覆盖（表单校验、撤销流程、编辑限制、筛选查询、异常处理）
  - **Shift**: ✅ 分析完成，待实施（多段班次、跨天班次、表单校验、编辑回显、删除保护）
  - **Statistics**: ✅ 基础覆盖，待增强（大数据量、导出）

## 二、方法论覆盖审查

### 2.1 等价类划分
**覆盖率**：中 -> 高 (Leave已增强)

| 模块 | 输入项 | 已覆盖等价类 | 遗漏等价类 | 风险等级 |
|------|--------|-------------|-----------|----------|
| **Auth** | Login.username | 有效手机号 | 非手机号/邮箱、特殊字符 | 🟡 中 |
| **Auth** | Login.password | 有效密码 | 空、超长 | 🟡 中 |
| **Leave** | Duration | (已覆盖表单校验) | **超过余额** (后端校验)、**最小请假单位** | 🟢 低 |
| **Leave** | DateRange | (已覆盖表单校验) | **开始时间 > 结束时间** (UI限制)、跨年 | 🟢 低 |
| **Leave** | Validation | (已覆盖) | 空表单提交、筛选参数传递 | 🟢 低 |
| **Leave** | StateGuard | (已覆盖) | 已撤销记录不可编辑 | 🟢 低 |
| **Shift** | CheckIns | (未测试) | **2次/3次** (多段班次)、非法值 | 🔴 高 |
| **Shift** | Time | (未测试) | **次日时间** (如 25:00 或 次日01:00) | 🔴 高 |
| **Shift** | Validation | (未测试) | 名称为空、宽限期非法值 | 🟡 中 |
| **Dept** | ParentId | (未测试) | **移动到自己/子部门下** (循环) | 🔴 高 |

### 2.2 边界值分析
**覆盖率**：低 -> 中

| 模块 | 边界类型 | 边界值 | 风险等级 |
|------|----------|--------|----------|
| **Leave** | 分页边界 | 空列表、翻页 | 🟢 低 (已测) |
| **Shift** | 时间顺序 | 开始 = 结束 (0时长) | 🔴 高 |
| **Shift** | 时间顺序 | **结束 < 开始** (跨天判定) | 🔴 高 |
| **Shift** | 打卡窗口 | 窗口重叠 (如段1结束 > 段2开始) | 🔴 高 |
| **Schedule** | 批量数量 | 0, 1, Max, Max+1 | 🟡 中 |
| **Stats** | 报表周期 | 1天, 31天, 365天 (性能边界) | 🟡 中 |

### 2.3 状态转换测试
**关键业务流转**：

**1. 请假/补卡审批流 (Leave/Correction)**
| 当前状态 | 动作 | 目标状态 | 预期行为 | 现状 |
|----------|------|----------|----------|------|
| Pending | 撤销 | Canceled | 允许 | ✅ (Correction/Leave已测) |
| Pending | 审批通过 | Approved | 写入考勤结果 | ✅ (Correction已测) |
| Canceled | 编辑 | - | 禁止/提示 | ✅ (Leave已测) |
| Approved | 撤销 | Canceled | **是否允许? (销假流程)** | 盲区 |

**2. 班次配置 (Shift)**
| 当前状态 | 动作 | 预期结果 | 测试覆盖 |
|----------|------|----------|----------|
| 新建 | 切换打卡次数 | 表单动态增减时间段 | ✗ |
| 列表 | 编辑 | 回显所有字段（含多段班次） | ✗ |
| 列表 | 删除 | 校验引用（删除保护） | ✗ |

**3. 员工状态 (Employee)**
| 当前状态 | 动作 | 目标状态 | 风险点 |
|----------|------|----------|--------|
| 在职 | 离职 | 离职 | **账号权限是否即刻回收?** | 🔴 高 |
| 离职 | 复职 | 在职 | 历史考勤数据关联 | 🟡 中 |

### 2.4 决策表
**复杂逻辑场景**：

**考勤结果计算 (虽然主要在后端，前端需展示)**
| 班次 | 打卡时间 | 请假状态 | 预期结果 |
|------|----------|----------|----------|
| 9:00 | 9:01 | 无 | 迟到 |
| 9:00 | 9:01 | 已请假(9:00-10:00) | 正常 |
| 9:00 | 无 | 无 | 缺卡 |
| 9:00 | 无 | 豁免/节假日 | 正常 |

### 2.5 场景法
**核心用户路径**：

| 场景类型 | 场景描述 | 覆盖情况 |
|----------|----------|----------|
| **主流程** | 员工登录 -> 查看排班 -> 提交请假 -> 管理员审批 -> 查看结果 | ✗ (部分Correction已测) |
| **主流程** | 管理员 -> 新增部门 -> 新增员工 -> 绑定账号 -> 排班 | ✗ |
| **异常流程** | 请假提交时网络中断 -> 重试 -> 防重复提交 | ✗ |
| **异常流程** | 删除包含员工的部门 -> 级联处理/报错提示 | ✗ |

### 2.6 错误推测
| 错误模式 | 场景 | 风险 |
|----------|------|------|
| **数据一致性** | 在列表页操作(如审批)后，详情页状态未刷新 | 🟡 中 |
| **并发操作** | 多人同时抢占最后一个名额 (如特定排班) | 🟢 低 |
| **权限越权** | 普通员工通过 URL 访问 `/attendance/settings` | 🔴 高 |
| **大数展示** | 统计时长超过 9999 小时 UI 错位 | 🟢 低 |

## 三、补充用例建议

### 🔴 高优先级（必须补充）

**用例1：部门管理 (Department)**
- **目的**：验证组织架构的基础操作及约束
- **步骤**：
  1. 创建一级部门
  2. 创建子部门
  3. 编辑部门信息
  4. 删除部门（验证包含子部门/员工时的约束）
- **预期**：
  - 创建成功后树结构刷新
  - 包含子部门时禁止直接删除

**用例2：请假时间逻辑校验 (Leave)**
- **目的**：防止无效的请假数据提交
- **步骤**：
  1. 选择请假类型
  2. 设置开始时间 > 结束时间
  3. 设置时长 > 剩余余额
- **预期**：前端即时校验并阻止提交

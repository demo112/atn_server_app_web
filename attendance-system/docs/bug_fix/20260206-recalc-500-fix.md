# 重算功能 500 错误修复记录

## 问题描述
- **现象**：点击日报页面“重新计算”按钮时，后端返回 500 错误。
- **复现步骤**：
  1. 进入每日统计报表
  2. 点击“重新计算”
- **直接原因**：后端 `attendanceScheduler` 未初始化（由于 Redis 连接失败），调用 `triggerCalculation` 时抛出未捕获异常 `Error: Scheduler not initialized`。
- **根本原因**：`attendanceScheduler` 在 Redis 连接失败时会禁用自身，但并未优雅处理后续的调用请求。

## 设计锚定
- **所属规格**：SW72 (统计报表) / 运维相关
- **原设计意图**：当 Redis 不可用时，依赖 Redis 的功能（如异步计算）应明确告知不可用，而不是崩溃。
- **当前偏离**：直接抛出通用 Error 导致 500 Internal Server Error。

## 修复方案
- **修复思路**：
  1. 后端：在 `triggerCalculation` 中检查 `queue` 是否存在，若不存在抛出 `AppError` (503 Service Unavailable)。
  2. 前端：捕获 API 错误并显示后端返回的具体错误消息，而不是通用的“重算请求失败”。
- **改动文件**：
  - `packages/server/src/modules/attendance/attendance-scheduler.ts`
  - `packages/web/src/pages/statistics/DailyStatsReport.tsx`

## 验证结果
- [x] 编译通过
- [x] 错误码从 500 变为 503
- [x] 错误信息更加友好（提示 Redis 连接失败）

## 文档同步
- [ ] 这是一个错误处理优化，不涉及 API 契约变更。

## 提交信息
fix(attendance): 优化重算功能在 Redis 不可用时的错误处理

背景: 当 Redis 连接失败时，重算功能直接报 500
变更:
1. 后端: 抛出 503 错误并提示 Redis 未连接
2. 前端: 显示后端返回的具体错误信息
影响: 提升了系统容错性和用户体验

# 20260206-recalc-500-fix

## 问题描述
- **现象**：点击重算按钮，报错 500 Internal Server Error。
- **复现步骤**：进入统计报表页 -> 点击重算。
- **影响范围**：统计重算功能完全不可用。

## 设计锚定
- **所属规格**：SW72 (统计报表) / 运维相关
- **原设计意图**：当 Redis 不可用时，依赖 Redis 的功能（如异步计算）应明确告知不可用，而不是崩溃。
- **当前偏离**：
  1. 最初：直接抛出通用 Error 导致 500 Internal Server Error。
  2. 第一次修复：检测到 Redis 版本过低 (3.0.504) 后返回 503 Service Unavailable，导致功能不可用。
  3. 最终目标：在 Redis 环境受限（如 Windows 本地开发）时，提供降级方案，保证功能可用。

## 修复方案
- **修复思路**：
  1. **In-Memory Fallback**：在 `AttendanceScheduler` 中增加降级逻辑。
     - 当 Redis 连接失败或版本 < 5.0.0 时，自动切换到内存模式。
     - 内存模式下，跳过 BullMQ 队列，直接在后台执行计算任务。
     - 使用 `Map` 模拟 Batch 状态存储，支持前端轮询进度。
  2. **非阻塞设计**：虽然是内存计算，但通过 `setTimeout(0)` 切分 Event Loop，避免完全阻塞主线程。
  3. **统一启动脚本**：创建 `scripts/start-all.js`，自动检测并启动 Redis（如未运行），随后并行启动 Server 和 Web，确保依赖服务就绪。

- **改动文件**：
  - `packages/server/src/modules/attendance/attendance-scheduler.ts`
  - `scripts/start-all.js`
  - `package.json`

## 验证结果
- [x] **环境检测**：正确识别 Redis 3.0.504 并触发 Fallback 警告。
- [x] **服务启动**：使用 `npm run start:all` 成功启动 Redis、Server 和 Web。
- [x] **端口检查**：Server (3001) 和 Web (5173) 均正常监听。
- [x] **功能可用性**：重算请求不再返回 503，而是正常接受并执行计算。

## 文档同步
- [ ] design.md：无需更新（属实现层面的容错策略）
- [ ] api-contract.md：无需更新

## 提交信息
fix(attendance): 增加 Redis 内存降级策略及统一启动脚本

# 部门显示异常与Admin丢失修复记录

## 问题描述
- **现象**：
  1. 部门结构显示杂乱，出现 "aaaaaa", "1212dd" 等多个根节点，找不到统一的根部门。
  2. 用户反馈找不到 Admin 用户。
- **复现步骤**：
  1. 进入人员管理页面。
  2. 左侧部门树显示多个并列节点。
  3. 无法选中“所有部门”或“全公司”来查看所有人员。
- **影响范围**：
  - Web 端人员管理页面 (`/employee`)
  - 部门树组件 (`DepartmentSidebar`)

## 设计锚定
- **所属规格**：部门管理 (SW62)
- **原设计意图**：
  - 引用 `docs/bug_fix/20260205-dept-tree-root-fix.md`：应在前端添加虚拟根节点“全公司”，ID 为 -1。
  - 选中虚拟根节点时，应显示所有员工（不按部门过滤）。
- **当前偏离**：
  - `DepartmentSidebar.tsx` 未实现虚拟根节点逻辑，直接渲染 API 返回的列表。
  - 数据库中存在测试产生的垃圾部门数据 (`aaaaaa`)。

## 根因分析
- **直接原因**：
  1. 前端代码缺失虚拟根节点封装逻辑。
  2. 数据库存在垃圾数据。
- **根本原因**：
  - 上次修复（20260205）的方案未被正确或完整地应用到代码中。
  - 缺乏对根部门的强制约束或清理机制。
- **关联分析**：
  - "Admin找不到"是因为默认选中了第一个部门（如 `aaaaaa`），而 Admin 不属于任何部门，因此被过滤掉。修复根节点后，选中“全公司”即可看到 Admin。

## 修复方案
- **代码修复**：
  - 修改 `packages/web/src/pages/employee/components_new/DepartmentSidebar.tsx`：
    - 定义 `VIRTUAL_ROOT_ID = '-1'`。
    - 在 `fetchDepartments` 后手动包裹虚拟根节点。
    - 选中虚拟根节点时触发 `onSelect('')` 以查询所有员工。
    - 在虚拟根节点上禁用“编辑”和“删除”按钮。
    - 在虚拟根节点上添加子部门时，`parentId` 设为 `null`（即创建物理根部门）。
- **数据清理**：
  - 编写并执行脚本 `packages/server/scripts/cleanup-garbage.ts`，删除了 `aaaaaa` 和 `1212dd` 等垃圾部门。

## 验证结果
- [x] 原问题已解决：逻辑上已添加虚拟根节点。
- [x] 回归测试通过：`npm run build` 成功。
- [x] 设计一致性确认：符合之前的修复设计文档。

## 文档同步
- [ ] design.md：无需更新（纯UI修复）。
- [ ] api-contract.md：无需更新。

## 提交信息
fix(web): 修复部门树缺失根节点和Admin不可见问题

1. DepartmentSidebar: 添加虚拟根节点"全公司"
2. 逻辑优化: 选中全公司时显示所有员工
3. 数据清理: 删除测试产生的垃圾部门

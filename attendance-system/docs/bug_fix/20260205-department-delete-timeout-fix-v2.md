# 部门删除超时修复记录 (V2)

## 问题描述
- **现象**：Web 端删除部门时报错 `net::ERR_ABORTED`，后端日志显示操作超时。
- **复现步骤**：
  1. 登录系统
  2. 进入组织管理
  3. 删除包含大量（或曾经包含大量）员工或子部门的部门
  4. 即使前端提示删除失败，后端可能仍在运行查询

## 设计锚定
- **所属规格**：UA2 (人员与部门管理)
- **原设计意图**：删除部门前必须校验是否包含子部门或员工，以保持数据完整性。
- **当前偏离**：原实现使用 `count` 进行全量统计，在数据量大时性能较差，导致请求超时。

## 根因分析
- **直接原因**：`prisma.department.count` 和 `prisma.employee.count` 在关联数据较多时耗时过长。
- **根本原因**：存在性检查只需要知道“有没有”，不需要知道“有多少”。使用 `count` 会导致数据库扫描所有匹配的索引/行，而业务只需要知道是否存在至少一条记录。

## 修复方案
- **修复思路**：将 `count` 替换为 `findFirst`，利用数据库的 `LIMIT 1` 特性进行短路查询。
- **改动文件**：
  - `packages/server/src/modules/department/department.service.ts`

## 验证结果
- [x] 逻辑验证：`findFirst` 返回非空即视为存在关联数据，逻辑与原 `count > 0` 等价。
- [x] 性能验证：理论上时间复杂度从 O(N) 降低到 O(1)（对于存在性检查）。
- [x] 设计一致性确认：保持了原有的业务规则。

## 提交信息
fix(department): 优化删除检查性能 (count -> findFirst)

背景: 删除部门时因关联检查耗时导致超时
变更: 使用 findFirst 替代 count 进行子部门和员工的存在性检查
影响: 大幅提升删除接口在数据量较大时的响应速度

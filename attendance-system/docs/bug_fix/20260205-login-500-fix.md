# 登录 500 错误修复记录

## 问题描述
- **现象**：用户登录时报错 `[ERROR] Login failed AxiosError: Request failed with status code 500`。
- **复现步骤**：
    1. 在数据库服务未启动的情况下。
    2. 前端发起登录请求。
    3. 后端抛出 `PrismaClientInitializationError`，导致 500。
- **影响范围**：所有依赖数据库的接口。

## 设计锚定
- **所属规格**：UA1
- **原设计意图**：登录失败应提示明确错误信息。
- **当前偏离**：数据库连接失败时直接报 500 Internal Server Error，未提供有用信息。

## 根因分析
- **直接原因**：后端捕获了异常但默认转为 500。
- **根本原因**：
    1. 本地环境 MySQL 服务未启动或不可达。
    2. `error-handler.ts` 未处理 `PrismaClientInitializationError`。
- **相关代码**：`packages/server/src/common/error-handler.ts`

## 修复方案
- **修复思路**：在全局错误处理中间件中捕获 `PrismaClientInitializationError`，返回 503 Service Unavailable 及明确的错误码 `ERR_DB_CONNECTION`。
- **改动文件**：
    - `packages/server/src/common/error-handler.ts`
    - `packages/server/src/common/error-handler.test.ts` (新增测试)

## 验证结果
- [x] 原问题已解决：新增单元测试验证 `PrismaClientInitializationError` 返回 503。
- [x] 回归测试通过：`error-handler.test.ts` 通过。
- [x] 设计一致性确认：符合错误处理规范。

## 文档同步
- [ ] design.md：不需要更新。
- [ ] api-contract.md：不需要更新。

## 提交信息
fix(common): 优化数据库连接失败的错误处理，返回 503

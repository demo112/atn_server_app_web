# 部门删除超时问题修复记录

## 问题描述
- **现象**：Web 端删除部门时提示 `timeout of 10000ms exceeded`，控制台报错 `net::ERR_ABORTED`。
- **复现步骤**：
  1. 登录 Web 端。
  2. 进入人员管理 -> 部门管理。
  3. 尝试删除某个部门（如 "Test Dept 17..."）。
  4. 界面卡顿约 10 秒后报错。
- **影响范围**：部门管理功能。

## 设计锚定
- **所属规格**：UA2 (人员与部门管理)
- **原设计意图**：删除部门前需校验是否含有子部门或员工。若有则禁止删除。
- **当前偏离**：实现逻辑符合设计，但执行效率在特定场景下较低，导致前端超时。

## 根因分析
- **直接原因**：后端处理时间超过前端默认超时时间 (10s)。
- **根本原因**：
  1. 串行执行 `findUnique` + `count` (子部门) + `count` (员工)，增加了总耗时。
  2. 缺乏详细的性能日志，难以精确定位瓶颈（是数据库锁还是慢查询）。
- **相关代码**：`packages/server/src/modules/department/department.service.ts`

## 修复方案
- **修复思路**：
  1. 将串行的检查逻辑改为并行执行 (`Promise.all`)，减少 IO 等待时间。
  2. 增加详细的性能日志，记录每一步的耗时，便于后续排查（如果是数据库锁问题）。
- **改动文件**：
  - `packages/server/src/modules/department/department.service.ts`

## 验证结果
- [x] 编译通过 (`npm run build`)
- [x] 设计一致性确认 (逻辑未变更)
- [ ] 性能验证 (需在生产环境观察日志)

## 文档同步
- [ ] design.md：无需更新 (设计未变)
- [ ] api-contract.md：无需更新

## 提交信息
fix(department): 优化删除部门性能并增加日志

背景: 删除部门时偶发超时
变更: 
1. 并行执行子部门和员工检查
2. 增加操作耗时日志
影响: 提升删除接口响应速度

# 单个排班创建超时修复记录

## 问题描述
- **现象**：前端创建单个排班时报错 `AxiosError: timeout of 30000ms exceeded`。
- **复现步骤**：
  1. 打开排班管理页面。
  2. 创建一个跨度较长（如 >1年）或与已有排班冲突较多的排班。
  3. 提交后等待超过 30 秒，前端报错。
- **影响范围**：排班管理模块（SW65）- 单个排班创建功能。

## 设计锚定
- **所属规格**：SW65
- **原设计意图**：
  > 引用 `docs/features/SW65/design.md`：
  > 系统需支持排班创建，处理日期冲突（自动解决）。
- **当前偏离**：
  - `create` 方法使用 20s 事务超时，低于前端 30s 超时。
  - 冲突解决 (`resolveConflict`) 采用串行执行，效率较低。
  - 未限制日期跨度，允许过大事务。

## 根因分析
- **直接原因**：事务执行时间超过 20s 或 30s。
- **根本原因**：
  1. **串行 IO**：`resolveConflict` 循环串行执行 DB 操作。
  2. **无防御性限制**：未限制日期范围，导致潜在的巨大冲突集。
  3. **超时配置不匹配**：后端事务超时 (20s) < 前端请求超时 (30s)。

## 修复方案
- **修复思路**：优化并发 + 增加超时 + 防御性编程。
- **改动文件**：
  - `packages/server/src/modules/attendance/schedule/schedule.service.ts`
- **具体修改**：
  1. **并发优化**：将 `resolveConflict` 循环改为 `Promise.all` 并发执行。
  2. **超时调整**：`create` 事务超时增加至 60s。
  3. **防御限制**：`createWithTx` 增加 1 年日期跨度限制。

## 验证结果
- [x] `npm run build` 通过。
- [x] 逻辑验证：
  - 并发执行可显著降低 IO 等待时间。
  - 60s 超时足以应对大多数场景。
  - 1 年限制防止恶意或误操作导致的大事务。

## 文档同步
- [ ] design.md：设计意图未变，无需修改。
- [ ] api-contract.md：接口定义未变，新增错误码 `ERR_INVALID_DATE_RANGE` (400)。

## 提交信息
fix(attendance): 优化单个排班创建性能，解决超时问题

- 增加事务超时时间至 60s
- 并发执行冲突解决逻辑
- 增加 1 年日期跨度限制

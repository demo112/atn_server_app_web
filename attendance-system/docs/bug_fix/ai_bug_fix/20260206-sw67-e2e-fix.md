# 修复 E2E 测试中请假撤销按钮点击失败问题

## 基本信息

| 项目 | 内容 |
|------|------|
| 发现日期 | 2026-02-06 |
| 状态 | 已解决 |
| 严重程度 | 高 (阻碍测试通过) |
| 修复者 | AI Agent (Trae) |

## 问题描述

在运行 SW67 (请假管理) 的 E2E 测试时，`撤销请假` 用例失败。
错误表现为 Playwright 无法点击 "撤销" 按钮，提示元素被拦截 (interception) 或无法定位到指定行。

## 根因分析

1. **列表数据干扰**：测试环境中存在多条请假记录，导致测试用例无法准确通过 `getByText(employeeName)` 定位到刚刚创建的那条记录。
2. **可视区域限制**：如果不进行筛选，目标记录可能位于列表底部（需滚动），导致 Playwright 尝试点击时被 sticky header 或其他元素遮挡。
3. **定位策略不稳**：原测试直接在表格中查找文本，当存在多行相似数据时，定位器匹配到多个元素或错误的元素。

## 解决方案

1. **增强 Page Object**：
   在 `LeavePage` (E2E) 中实现 `filterByEmployee` 方法，利用前端的“人员选择”功能进行精确筛选。

   ```typescript
   async filterByEmployee(name: string) {
     await this.page.click('input[placeholder="选择部门或人员"]');
     // ... 在弹窗中搜索并选择人员 ...
   }
   ```

2. **优化测试流程**：
   在执行“撤销”操作前，先调用 `filterByEmployee` 筛选出该测试员工的记录。

   ```typescript
   // Act
   await leavePage.filterByEmployee(testEmployee.name); // 关键步骤：先筛选
   await leavePage.cancelLeave(testEmployee.name);
   ```

3. **移除调试代码**：
   修复完成后，移除了调试用的 `console.log` 和 `page.on('console')` 监听。

## 验证结果

运行 E2E 测试：
`pnpm test:e2e -- --grep "请假"`

结果：**12/12 passing**。撤销功能测试稳定通过。

## 相关文件

- `packages/e2e/pages/leave.page.ts`
- `packages/e2e/tests/attendance/leave.spec.ts`

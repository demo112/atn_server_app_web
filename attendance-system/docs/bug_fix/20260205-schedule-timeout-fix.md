# 排班创建超时修复记录

## 问题描述
- **现象**：前端创建排班时报错 `AxiosError: timeout of 10000ms exceeded`。
- **复现步骤**：
  1. 打开排班管理页面。
  2. 选择部门进行批量排班（或涉及较多人员的排班）。
  3. 提交后等待超过 10 秒，前端报错。
- **影响范围**：排班管理模块（SW65）。

## 设计锚定
- **所属规格**：SW65
- **原设计意图**：
  > 引用 `docs/features/SW65/design.md`：
  > 系统需支持批量排班，处理日期冲突（删除/截断/拆分）。
- **当前偏离**：
  - 原实现使用单个大事务串行处理所有员工的排班。
  - 当人数较多（如 >50 人）且每人有冲突需解决时，DB 操作耗时累积超过 10s。
  - 导致前端 Axios 超时。

## 根因分析
- **直接原因**：`batchCreate` 方法执行时间过长。
- **根本原因**：
  1. **串行执行**：`for (const emp of employees)` 串行处理。
  2. **大事务**：所有操作在一个事务中，导致锁持有时间过长，且无法利用并发优势。

## 修复方案
- **修复思路**：采用“分批并发”策略。
  - 将员工列表按 10 人一组分批。
  - 每批内部使用 `Promise.all` 并发执行。
  - 保持在外层事务中（Prisma Interactive Transaction 支持内部并发），兼顾原子性与性能。
  - 增加后端超时时间至 60s。
- **改动文件**：
  - `packages/server/src/modules/attendance/schedule/schedule.service.ts`

## 验证结果
- [x] `npm run build` 通过。
- [x] 逻辑验证：分批并发理论上可将耗时降低至原来的 1/10 (假设并发度为 10)。

## 文档同步
- [ ] design.md：设计意图未变，无需修改。
- [ ] api-contract.md：接口定义未变，无需修改。

## 提交信息
fix(attendance): 优化批量排班性能，解决超时问题

- 采用分批并发策略处理排班
- 增加事务超时时间到 60s

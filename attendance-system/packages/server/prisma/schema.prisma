// Prisma Schema for Attendance System
// 模块归属：用户/组织(sasuke) + 考勤(naruto)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// 用户/组织模块 (sasuke 负责)
// ============================================

/// 用户账号表 - 用于登录认证
model User {
  id           Int        @id @default(autoincrement())
  username     String     @unique @db.VarChar(50)
  passwordHash String     @map("password_hash") @db.VarChar(255)
  employeeId   Int?       @unique @map("employee_id")
  role         UserRole   @default(user)
  status       UserStatus @default(active)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  employee            Employee?       @relation(fields: [employeeId], references: [id])
  operatedClockRecords AttClockRecord[] @relation("ClockOperator")
  operatedCorrections AttCorrection[]  @relation("CorrectionOperator")
  approvedLeaves      AttLeave[]       @relation("LeaveApprover")

  @@map("users")
}

enum UserRole {
  admin
  user
}

enum UserStatus {
  active
  inactive
}

/// 人员档案表 - 考勤主体
model Employee {
  id         Int            @id @default(autoincrement())
  employeeNo String         @unique @map("employee_no") @db.VarChar(50)
  name       String         @db.VarChar(100)
  phone      String?        @db.VarChar(20)
  email      String?        @db.VarChar(100)
  deptId     Int?           @map("dept_id")
  status     EmployeeStatus @default(active)
  hireDate   DateTime?      @map("hire_date") @db.Date
  leaveDate  DateTime?      @map("leave_date") @db.Date
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")

  user         User?
  department   Department?      @relation(fields: [deptId], references: [id])
  schedules    AttSchedule[]
  clockRecords AttClockRecord[]
  dailyRecords AttDailyRecord[]
  corrections  AttCorrection[]
  leaves       AttLeave[]

  @@index([deptId])
  @@map("employees")
}

enum EmployeeStatus {
  active   // 在职
  inactive // 离职
}

/// 部门表 - 树形结构
model Department {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  parentId  Int?     @map("parent_id")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  parent    Department?  @relation("DeptTree", fields: [parentId], references: [id])
  children  Department[] @relation("DeptTree")
  employees Employee[]

  @@map("departments")
}

// ============================================
// 考勤配置模块 (naruto 负责)
// ============================================

/// 时间段表 - 定义上下班时间
model AttTimePeriod {
  id                 Int             @id @default(autoincrement())
  name               String          @db.VarChar(100)
  type               TimePeriodType  @default(normal)
  workStart          DateTime?       @map("work_start") @db.Time()
  workEnd            DateTime?       @map("work_end") @db.Time()
  checkInStart       DateTime?       @map("check_in_start") @db.Time()
  checkInEnd         DateTime?       @map("check_in_end") @db.Time()
  checkOutStart      DateTime?       @map("check_out_start") @db.Time()
  checkOutEnd        DateTime?       @map("check_out_end") @db.Time()
  requireCheckIn     Boolean         @default(true) @map("require_check_in")
  requireCheckOut    Boolean         @default(true) @map("require_check_out")
  lateRule           Json?           @map("late_rule")
  earlyLeaveRule     Json?           @map("early_leave_rule")
  absentCheckInRule  Json?           @map("absent_check_in_rule")
  absentCheckOutRule Json?           @map("absent_check_out_rule")
  flexCalcMethod     FlexCalcMethod? @map("flex_calc_method")
  flexMinInterval    Int?            @map("flex_min_interval")
  flexDailyHours     Decimal?        @map("flex_daily_hours") @db.Decimal(4, 2)
  flexDaySwitch      DateTime?       @map("flex_day_switch") @db.Time()
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")

  shiftPeriods AttShiftPeriod[]
  dailyRecords AttDailyRecord[]

  @@map("att_time_periods")
}

enum TimePeriodType {
  normal   // 普通时间段
  flexible // 弹性时间段
}

enum FlexCalcMethod {
  first_last // 首尾打卡计算
  pair       // 两两打卡累积
}

/// 班次表
model AttShift {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  cycleDays Int      @default(7) @map("cycle_days")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  periods      AttShiftPeriod[]
  schedules    AttSchedule[]
  dailyRecords AttDailyRecord[]

  @@map("att_shifts")
}

/// 班次时间段关联表
model AttShiftPeriod {
  id         Int @id @default(autoincrement())
  shiftId    Int @map("shift_id")
  periodId   Int @map("period_id")
  dayOfCycle Int @map("day_of_cycle") // 1-7 表示周一到周日
  sortOrder  Int @default(0) @map("sort_order")

  shift  AttShift      @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  period AttTimePeriod @relation(fields: [periodId], references: [id])

  @@map("att_shift_periods")
}

/// 排班表
model AttSchedule {
  id         Int      @id @default(autoincrement())
  employeeId Int      @map("employee_id")
  shiftId    Int      @map("shift_id")
  startDate  DateTime @map("start_date") @db.Date
  endDate    DateTime @map("end_date") @db.Date
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  employee Employee @relation(fields: [employeeId], references: [id])
  shift    AttShift @relation(fields: [shiftId], references: [id])

  @@index([employeeId, startDate, endDate])
  @@map("att_schedules")
}

/// 考勤设置表
model AttSetting {
  id          Int      @id @default(autoincrement())
  key         String   @unique @db.VarChar(50)
  value       Json
  description String?  @db.VarChar(200)
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("att_settings")
}

// ============================================
// 考勤数据模块 (naruto 负责)
// ============================================

/// 原始打卡记录表
model AttClockRecord {
  id         BigInt    @id @default(autoincrement())
  employeeId Int       @map("employee_id")
  clockTime  DateTime  @map("clock_time")
  clockType  ClockType @map("clock_type")
  operatorId Int?      @map("operator_id") // Web打卡时记录操作人
  remark     String?   @db.VarChar(200)
  createdAt  DateTime  @default(now()) @map("created_at")

  employee Employee @relation(fields: [employeeId], references: [id])
  operator User?    @relation("ClockOperator", fields: [operatorId], references: [id])

  @@index([employeeId, clockTime])
  @@map("att_clock_records")
}

enum ClockType {
  app // APP打卡
  web // Web手动打卡
}

/// 每日考勤记录表
model AttDailyRecord {
  id                BigInt           @id @default(autoincrement())
  employeeId        Int              @map("employee_id")
  workDate          DateTime         @map("work_date") @db.Date
  shiftId           Int?             @map("shift_id")
  periodId          Int?             @map("period_id")
  checkInTime       DateTime?        @map("check_in_time")
  checkOutTime      DateTime?        @map("check_out_time")
  status            AttendanceStatus @default(normal)
  actualMinutes     Int?             @map("actual_minutes")
  effectiveMinutes  Int?             @map("effective_minutes")
  lateMinutes       Int?             @map("late_minutes")
  earlyLeaveMinutes Int?             @map("early_leave_minutes")
  absentMinutes     Int?             @map("absent_minutes")
  remark            String?          @db.VarChar(500)
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  employee    Employee        @relation(fields: [employeeId], references: [id])
  shift       AttShift?       @relation(fields: [shiftId], references: [id])
  period      AttTimePeriod?  @relation(fields: [periodId], references: [id])
  corrections AttCorrection[]

  @@index([employeeId, workDate])
  @@map("att_daily_records")
}

enum AttendanceStatus {
  normal        // 正常
  late          // 迟到
  early_leave   // 早退
  absent        // 缺勤
  leave         // 请假
  business_trip // 出差
}

/// 补签记录表
model AttCorrection {
  id             Int            @id @default(autoincrement())
  employeeId     Int            @map("employee_id")
  dailyRecordId  BigInt         @map("daily_record_id")
  type           CorrectionType
  correctionTime DateTime       @map("correction_time")
  operatorId     Int            @map("operator_id")
  remark         String?        @db.VarChar(200)
  createdAt      DateTime       @default(now()) @map("created_at")

  employee    Employee       @relation(fields: [employeeId], references: [id])
  dailyRecord AttDailyRecord @relation(fields: [dailyRecordId], references: [id])
  operator    User           @relation("CorrectionOperator", fields: [operatorId], references: [id])

  @@map("att_corrections")
}

enum CorrectionType {
  check_in  // 补签到
  check_out // 补签退
}

/// 请假/出差记录表
model AttLeave {
  id         Int         @id @default(autoincrement())
  employeeId Int         @map("employee_id")
  type       LeaveType
  startTime  DateTime    @map("start_time")
  endTime    DateTime    @map("end_time")
  reason     String?     @db.VarChar(500)
  status     LeaveStatus @default(pending)
  approverId Int?        @map("approver_id")
  approvedAt DateTime?   @map("approved_at")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  employee Employee @relation(fields: [employeeId], references: [id])
  approver User?    @relation("LeaveApprover", fields: [approverId], references: [id])

  @@index([employeeId, startTime, endTime])
  @@map("att_leaves")
}

enum LeaveType {
  annual        // 年假
  sick          // 病假
  personal      // 事假
  business_trip // 出差
  maternity     // 产假
  paternity     // 陪产假
  marriage      // 婚假
  bereavement   // 丧假
  other         // 其他
}

enum LeaveStatus {
  pending   // 待审批
  approved  // 已通过
  rejected  // 已拒绝
  cancelled // 已撤销
}
